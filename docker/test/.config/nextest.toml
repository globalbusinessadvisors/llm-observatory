# Nextest configuration for LLM Observatory
# https://nexte.st/book/configuration.html

[profile.default]
# Default test threads (can be overridden by TEST_THREADS env var)
test-threads = 4

# Retry failed tests once by default
retries = 1

# Show standard output for failed tests
failure-output = "immediate-final"

# Status level for test results
status-level = "pass"

# Slow test timeout
slow-timeout = { period = "60s", terminate-after = 2 }

# Test timeout
timeout = { period = "300s" }

[profile.ci]
# CI-optimized profile for faster feedback
test-threads = 8

# No retries in CI to catch flaky tests
retries = 0

# Show all output for failed tests
failure-output = "immediate-final"

# More verbose status in CI
status-level = "all"

# Strict timeouts in CI
slow-timeout = { period = "30s", terminate-after = 1 }
timeout = { period = "180s" }

# Fail fast in CI
fail-fast = false

# Archive test results
archive.format = "auto"

[profile.ci.junit]
# JUnit output for CI integration
path = "test-results/junit.xml"
store-success-output = true
store-failure-output = true

[profile.fast]
# Fast profile for local development - run only fast tests
test-threads = "num-cpus"
retries = 0
status-level = "skip"

# Very short timeouts for fast tests only
slow-timeout = { period = "5s" }
timeout = { period = "30s" }

[profile.integration]
# Profile for integration tests - longer timeouts
test-threads = 2
retries = 1
slow-timeout = { period = "120s", terminate-after = 2 }
timeout = { period = "600s" }

[profile.debug]
# Debug profile with verbose output
test-threads = 1
retries = 0
failure-output = "immediate"
success-output = "immediate"
status-level = "all"

# No timeout for debugging
slow-timeout = { period = "0s" }
timeout = { period = "0s" }

# Configuration for test groups
[test-groups]
# Integration tests are slower
integration = { max-threads = 2 }

# Database tests need serialization
database = { max-threads = 1 }

# API tests can run in parallel
api = { max-threads = 4 }

# Script overrides
[[profile.default.overrides]]
filter = 'test(test_database)'
test-group = 'database'

[[profile.default.overrides]]
filter = 'test(test_api)'
test-group = 'api'

[[profile.default.overrides]]
filter = 'test(integration_)'
test-group = 'integration'
slow-timeout = { period = "120s" }

# Mark slow tests
[[profile.default.overrides]]
filter = 'test(slow_)'
slow-timeout = { period = "300s" }
timeout = { period = "600s" }

# Mark flaky tests in development
[[profile.default.overrides]]
filter = 'test(flaky_)'
retries = 3
