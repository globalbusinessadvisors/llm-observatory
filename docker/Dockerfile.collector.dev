# =============================================================================
# Development Dockerfile for LLM Observatory Collector Service
# =============================================================================
# Optimized for fast iteration with hot-reload and debug symbols
# Includes cargo-watch for automatic rebuilds on code changes
# =============================================================================

FROM rust:1.75-slim

# Install development dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    protobuf-compiler \
    libprotobuf-dev \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install cargo-watch for hot reload
RUN cargo install cargo-watch --version 8.5.2

# Install additional development tools
RUN cargo install cargo-expand --version 1.0.86 && \
    cargo install cargo-audit --version 0.20.0

# Create app directory
WORKDIR /app

# Create non-root user (but with sudo for dev convenience)
RUN groupadd -r collector --gid=1000 && \
    useradd -r -g collector --uid=1000 --home-dir=/app collector && \
    chown -R collector:collector /app

# Switch to non-root user
USER collector

# Environment variables for development
ENV RUST_LOG=debug \
    RUST_BACKTRACE=full \
    CARGO_INCREMENTAL=1 \
    CARGO_TARGET_DIR=/app/target \
    COLLECTOR_OTLP_GRPC_ENDPOINT=0.0.0.0:4317 \
    COLLECTOR_OTLP_HTTP_ENDPOINT=0.0.0.0:4318 \
    COLLECTOR_METRICS_ENDPOINT=0.0.0.0:9091 \
    COLLECTOR_HEALTH_ENDPOINT=0.0.0.0:8080 \
    COLLECTOR_LOG_LEVEL=debug \
    COLLECTOR_LOG_FORMAT=pretty

# Expose ports
# 4317: OTLP gRPC receiver
# 4318: OTLP HTTP receiver
# 9091: Prometheus metrics endpoint
# 8080: Health check endpoint
EXPOSE 4317 4318 9091 8080

# Health check (more lenient for development)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=5 \
    CMD curl -f http://localhost:8080/health || exit 1

# Labels
LABEL org.opencontainers.image.title="LLM Observatory Collector (Development)" \
      org.opencontainers.image.description="Development build with hot-reload" \
      com.llm-observatory.component="collector" \
      com.llm-observatory.environment="development"

# Volume mount points (for source code and cargo cache)
VOLUME ["/app", "/usr/local/cargo/registry"]

# Default command: use cargo-watch for hot reload
# This watches for file changes and rebuilds automatically
CMD ["cargo", "watch", \
     "-x", "check", \
     "-x", "test", \
     "-x", "run --package llm-observatory-collector", \
     "-w", "crates/collector", \
     "-w", "crates/core", \
     "-w", "crates/providers"]
