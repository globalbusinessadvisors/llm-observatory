# ============================================================================
# LLM Observatory - API Service Development Dockerfile
# ============================================================================
#
# This development Dockerfile provides:
# - cargo-watch for hot reload on code changes
# - GraphQL playground enabled
# - Debug logging and symbols
# - Fast incremental rebuilds
# - Development tools and utilities
#
# Build:  docker build -f docker/Dockerfile.api.dev -t llm-observatory-api:dev .
# Run:    docker-compose up api-dev
#
# ============================================================================

FROM rust:1.83-bookworm AS development

# Install development dependencies and tools
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libpq-dev \
    protobuf-compiler \
    # Development tools
    git \
    vim \
    curl \
    jq \
    postgresql-client \
    # Debugging tools
    gdb \
    strace \
    && rm -rf /var/lib/apt/lists/*

# Install Rust development tools
RUN cargo install cargo-watch --version 8.5.1 && \
    cargo install cargo-edit --version 0.12.3 && \
    rustup component add rustfmt clippy

# Create app user (matches production for consistency)
RUN groupadd -r -g 1000 apiuser && \
    useradd -r -u 1000 -g apiuser -m -s /bin/bash apiuser

# Create workspace directory
WORKDIR /app

# Copy workspace configuration first (for dependency caching)
COPY --chown=apiuser:apiuser Cargo.toml Cargo.lock ./

# Create dummy crates to cache dependencies
RUN mkdir -p crates/api/src crates/core/src crates/storage/src crates/sdk/src \
    crates/providers/src crates/collector/src crates/cli/src && \
    echo "fn main() {}" > crates/api/src/main.rs && \
    echo "pub fn placeholder() {}" > crates/core/src/lib.rs && \
    echo "pub fn placeholder() {}" > crates/storage/src/lib.rs && \
    echo "pub fn placeholder() {}" > crates/sdk/src/lib.rs && \
    echo "pub fn placeholder() {}" > crates/providers/src/lib.rs && \
    echo "pub fn placeholder() {}" > crates/collector/src/lib.rs && \
    echo "fn main() {}" > crates/cli/src/main.rs

# Copy all crate Cargo.toml files
COPY --chown=apiuser:apiuser crates/*/Cargo.toml ./crates/

# Build dependencies (this layer is cached)
RUN cargo build && \
    rm -rf crates/*/src target/debug/deps/llm_observatory*

# Copy the actual source code
COPY --chown=apiuser:apiuser . .

# Create directories for logs and temporary files
RUN mkdir -p /app/logs /app/tmp && \
    chown -R apiuser:apiuser /app

# Switch to non-root user
USER apiuser

# Expose ports
# 8080 - API service (REST/GraphQL)
# 9090 - Metrics/Prometheus endpoint
# 5555 - Optional: GraphQL Playground (dev only)
EXPOSE 8080 9090 5555

# Development environment variables
ENV RUST_LOG=debug \
    RUST_BACKTRACE=full \
    APP_HOST=0.0.0.0 \
    APP_PORT=8080 \
    METRICS_PORT=9090 \
    ENVIRONMENT=development \
    # Enable GraphQL playground
    GRAPHQL_PLAYGROUND=true \
    # Enable debug mode
    DEBUG=true \
    # Enable query logging
    DB_QUERY_LOGGING=true \
    # Fast compilation settings
    CARGO_INCREMENTAL=1 \
    CARGO_BUILD_JOBS=4

# Health check for development
HEALTHCHECK --interval=10s --timeout=3s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# Use cargo-watch to auto-rebuild on changes
# -x: Execute cargo command
# -w: Watch specific directories
# --why: Print reason for restart
# -i: Ignore patterns
ENTRYPOINT ["cargo", "watch"]

# Default: watch and run the API service
# This will automatically rebuild and restart on code changes
CMD [ \
    "-x", "run --bin llm-observatory-api -- serve", \
    "-w", "crates/api/src", \
    "-w", "crates/core/src", \
    "-w", "crates/storage/src", \
    "-w", "crates/sdk/src", \
    "-w", "crates/providers/src", \
    "--why", \
    "-i", "*.swp", \
    "-i", "*.tmp", \
    "-i", "target/*" \
]

# ============================================================================
# Alternative Commands (for reference):
# ============================================================================
#
# Run with specific features:
# docker run llm-observatory-api:dev cargo run --bin llm-observatory-api --features graphql
#
# Run tests on changes:
# docker run llm-observatory-api:dev cargo watch -x "test --lib"
#
# Run clippy on changes:
# docker run llm-observatory-api:dev cargo watch -x "clippy -- -D warnings"
#
# Interactive shell:
# docker run -it llm-observatory-api:dev bash
#
# ============================================================================

# ============================================================================
# Metadata
# ============================================================================
LABEL maintainer="LLM Observatory Contributors" \
      org.opencontainers.image.title="LLM Observatory API (Development)" \
      org.opencontainers.image.description="Development image with hot reload for LLM Observatory API" \
      org.opencontainers.image.vendor="LLM Observatory" \
      org.opencontainers.image.licenses="Apache-2.0" \
      environment="development" \
      hot-reload="enabled"
