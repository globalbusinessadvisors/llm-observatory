# PostgreSQL Production Configuration
# Optimized for 32GB RAM server with SSD storage
# Adjust values based on your actual hardware specs

# Connection Settings
max_connections = 400
superuser_reserved_connections = 3

# Memory Configuration
shared_buffers = 8GB                    # 25% of RAM
effective_cache_size = 24GB             # 75% of RAM
work_mem = 128MB                        # Per-operation memory
maintenance_work_mem = 2GB              # For VACUUM, CREATE INDEX
max_stack_depth = 7MB
dynamic_shared_memory_type = posix

# WAL (Write-Ahead Log) Configuration
wal_level = replica                     # Enable replication
wal_buffers = 16MB
max_wal_size = 8GB
min_wal_size = 2GB
wal_compression = on
wal_log_hints = on

# Replication Settings
max_wal_senders = 10
max_replication_slots = 10
hot_standby = on
hot_standby_feedback = on

# Checkpoints
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# Archiving (for PITR)
archive_mode = on
archive_command = 'test ! -f /var/lib/postgresql/wal_archive/%f && cp %p /var/lib/postgresql/wal_archive/%f'
archive_timeout = 3600                  # Archive every hour

# Query Planning
random_page_cost = 1.1                  # SSD optimized
effective_io_concurrency = 200          # SSD: 200, HDD: 2
seq_page_cost = 1.0

# Parallel Query
max_parallel_workers_per_gather = 4
max_parallel_maintenance_workers = 4
max_parallel_workers = 8
max_worker_processes = 8
parallel_leader_participation = on

# Cost-Based Vacuum Delay
vacuum_cost_delay = 0                   # No delay on SSD
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20
vacuum_cost_limit = 200

# Autovacuum
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

# Background Writer
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 512kB

# Asynchronous Behavior
backend_flush_after = 0                 # Disable for SSD

# Query Tuning
enable_partitionwise_join = on
enable_partitionwise_aggregate = on

# Lock Management
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64
deadlock_timeout = 1s

# Connection Pooling (if not using external pooler)
tcp_keepalives_idle = 60
tcp_keepalives_interval = 10
tcp_keepalives_count = 6

# Logging Configuration
logging_collector = on
log_directory = '/var/lib/postgresql/data/log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = off

# What to Log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 100        # Log queries > 100ms
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_error_verbosity = default
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_lock_waits = on
log_statement = 'ddl'                   # Log DDL statements
log_temp_files = 0                      # Log all temp files
log_timezone = 'UTC'

# Statistics
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
track_activity_query_size = 4096
stats_temp_directory = '/var/run/postgresql'

# Statement Statistics (pg_stat_statements)
shared_preload_libraries = 'timescaledb,pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# TimescaleDB Specific
timescaledb.max_background_workers = 8

# Locale and Formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# Security
ssl = on
ssl_cert_file = '/var/lib/postgresql/certs/server.crt'
ssl_key_file = '/var/lib/postgresql/certs/server.key'
ssl_ca_file = '/var/lib/postgresql/certs/ca.crt'
ssl_prefer_server_ciphers = on
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'

# Password encryption
password_encryption = scram-sha-256

# Resource Usage Limits
temp_file_limit = -1                    # No limit (adjust if needed)
