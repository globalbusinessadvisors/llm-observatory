# LLM Observatory: Architecture Diagrams

**Version:** 1.0
**Date:** 2025-11-05

---

## 1. System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         LLM APPLICATIONS LAYER                              │
│                                                                              │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│   │  Python App  │  │   Node.js    │  │  Rust App    │  │   Go App     │  │
│   │  (LangChain) │  │  (Vercel AI) │  │   (Custom)   │  │  (LlamaIndex)│  │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│          │                  │                  │                  │          │
│          └──────────────────┴──────────────────┴──────────────────┘          │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      INSTRUMENTATION LAYER (Rust SDK)                        │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  LLM Observatory SDK                                                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │  │ OpenAI Hook  │  │Anthropic Hook│  │ LangChain    │             │   │
│  │  └──────┬───────┘  └──────┬───────┘  │ Interceptor  │             │   │
│  │         │                  │          └──────┬───────┘             │   │
│  │         └──────────────────┴─────────────────┘                     │   │
│  │                            │                                        │   │
│  │                            ▼                                        │   │
│  │         ┌──────────────────────────────────────┐                   │   │
│  │         │   OpenTelemetry SDK (Rust)           │                   │   │
│  │         │   - Trace Context Propagation        │                   │   │
│  │         │   - Span Builder                     │                   │   │
│  │         │   - Metrics Collection               │                   │   │
│  │         │   - Batch Processing                 │                   │   │
│  │         └──────────────┬───────────────────────┘                   │   │
│  └────────────────────────┼─────────────────────────────────────────────┘   │
└───────────────────────────┼─────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COLLECTION LAYER (Rust/Go)                                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  OpenTelemetry Collector Cluster                                     │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │ Collector 1  │  │ Collector 2  │  │ Collector N  │              │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │   │
│  │         │                  │                  │                      │   │
│  │         └──────────────────┴──────────────────┘                      │   │
│  │                            │                                         │   │
│  │         ┌──────────────────┴──────────────────┐                     │   │
│  │         │                                      │                     │   │
│  │         ▼                                      ▼                     │   │
│  │  ┌──────────────┐                      ┌──────────────┐            │   │
│  │  │  Receivers   │                      │  Processors  │            │   │
│  │  ├──────────────┤                      ├──────────────┤            │   │
│  │  │  OTLP/gRPC   │                      │   Batching   │            │   │
│  │  │  OTLP/HTTP   │ ──────────────────→  │   Sampling   │            │   │
│  │  │  Jaeger      │                      │  Filtering   │            │   │
│  │  │  Zipkin      │                      │  Enrichment  │            │   │
│  │  └──────────────┘                      └──────┬───────┘            │   │
│  │                                               │                     │   │
│  │                                               ▼                     │   │
│  │                                        ┌──────────────┐            │   │
│  │                                        │  Exporters   │            │   │
│  │                                        ├──────────────┤            │   │
│  │                                        │ OTLP (Tempo) │            │   │
│  │                                        │ Prometheus   │            │   │
│  │                                        │ Loki         │            │   │
│  │                                        └──────┬───────┘            │   │
│  └───────────────────────────────────────────────┼──────────────────────┘   │
└────────────────────────────────────────────────┼──────────────────────────┘
                                                 │
                    ┌────────────────────────────┼────────────────────────┐
                    │                            │                        │
                    ▼                            ▼                        ▼
      ┌─────────────────────┐      ┌─────────────────────┐   ┌─────────────────────┐
      │  METRICS STORAGE    │      │  TRACE STORAGE      │   │   LOG STORAGE       │
      │                     │      │                     │   │                     │
      │  ┌───────────────┐  │      │  ┌───────────────┐ │   │  ┌───────────────┐  │
      │  │ TimescaleDB   │  │      │  │ Grafana Tempo │ │   │  │ Grafana Loki  │  │
      │  │               │  │      │  │               │ │   │  │               │  │
      │  │ - Hypertables │  │      │  │ - Distributor │ │   │  │ - Distributor │  │
      │  │ - Continuous  │  │      │  │ - Ingester    │ │   │  │ - Ingester    │  │
      │  │   Aggregates  │  │      │  │ - Querier     │ │   │  │ - Querier     │  │
      │  │ - Compression │  │      │  │ - Compactor   │ │   │  │               │  │
      │  │               │  │      │  │               │ │   │  │               │  │
      │  └───────┬───────┘  │      │  └───────┬───────┘ │   │  └───────┬───────┘  │
      │          │          │      │          │         │   │          │          │
      │          ▼          │      │          ▼         │   │          ▼          │
      │  ┌───────────────┐  │      │  ┌───────────────┐ │   │  ┌───────────────┐  │
      │  │  PostgreSQL   │  │      │  │ Object Storage│ │   │  │ Object Storage│  │
      │  │  (SSD/NVMe)   │  │      │  │  (S3/GCS)     │ │   │  │  (S3/GCS)     │  │
      │  └───────────────┘  │      │  └───────────────┘ │   │  └───────────────┘  │
      └─────────────────────┘      └─────────────────────┘   └─────────────────────┘
                    │                            │                        │
                    └────────────────────────────┼────────────────────────┘
                                                 │
                                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     VISUALIZATION & QUERY LAYER                              │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   Grafana    │  │  Custom UI   │  │  Query API   │  │   Alerting   │   │
│  │              │  │  (Rust/WASM) │  │  (GraphQL)   │  │    Engine    │   │
│  │ - Metrics    │  │ - Trace Viz  │  │              │  │              │   │
│  │ - Traces     │  │ - Cost Track │  │ - Unified    │  │ - Prometheus │   │
│  │ - Logs       │  │ - Token Viz  │  │   Query      │  │   Rules      │   │
│  │ - Dashboards │  │ - Comparisons│  │ - Analytics  │  │ - Webhooks   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Data Flow Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 1: REQUEST INTERCEPTION                                           │
└──────────────────────────────────────────────────────────────────────────┘

   Application makes LLM call
          │
          ▼
   ┌─────────────────┐
   │ SDK Interceptor │  ← Auto-instrumentation hook
   └────────┬────────┘
            │
            ├─→ Extract: model, provider, parameters
            ├─→ Start span (trace_id, span_id)
            ├─→ Propagate context (W3C Trace Context)
            └─→ Record start time
                   │
                   ▼

┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 2: REQUEST EXECUTION                                              │
└──────────────────────────────────────────────────────────────────────────┘

            LLM API call proceeds
                   │
                   ├─→ Track: network time
                   ├─→ Monitor: streaming tokens (if applicable)
                   └─→ Capture: errors (if any)
                          │
                          ▼

┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 3: RESPONSE PROCESSING                                            │
└──────────────────────────────────────────────────────────────────────────┘

            Response received
                   │
                   ├─→ Calculate: duration, TTFT, tokens/sec
                   ├─→ Extract: token counts from response
                   ├─→ Compute: cost (based on pricing table)
                   ├─→ Record: response metadata
                   └─→ End span
                          │
                          ▼

┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 4: SAMPLING DECISION                                              │
└──────────────────────────────────────────────────────────────────────────┘

            Sampling logic
                   │
                   ├─→ Is error? ──────────────────→ [SAMPLE 100%]
                   │                                       │
                   ├─→ Is slow (>5s)? ─────────────→ [SAMPLE 100%]
                   │                                       │
                   ├─→ Is expensive (>$1)? ────────→ [SAMPLE 100%]
                   │                                       │
                   └─→ Normal request ─────────────→ [SAMPLE 1%]
                                                            │
                   ┌────────────────────────────────────────┘
                   │
                   ├─→ [DROP 99%] ──→ Increment counters only
                   │                         │
                   └─→ [SAMPLE 1%] ─────────┘
                                             │
                                             ▼

┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 5: BATCH BUFFERING                                                │
└──────────────────────────────────────────────────────────────────────────┘

            In-memory buffer
                   │
                   ├─→ Accumulate spans (max 512)
                   ├─→ Wait for time window (10s)
                   └─→ Trigger: batch full OR timeout
                          │
                          ▼

┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 6: EXPORT TO COLLECTOR                                            │
└──────────────────────────────────────────────────────────────────────────┘

            OTLP/gRPC export
                   │
                   ├─→ Serialize: spans to protobuf
                   ├─→ Compress: gzip
                   ├─→ Send: to collector (with retry)
                   └─→ Clear buffer
                          │
                          ▼

┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 7: COLLECTOR PROCESSING                                           │
└──────────────────────────────────────────────────────────────────────────┘

            Collector pipeline
                   │
                   ├─→ Tail sampling (wait 10s for complete trace)
                   ├─→ Enrichment (add cluster metadata)
                   ├─→ Filtering (remove internal spans)
                   └─→ Routing (to appropriate backends)
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼

┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 8: STORAGE                                                        │
└──────────────────────────────────────────────────────────────────────────┘

  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
  │  Metrics    │    │   Traces    │    │    Logs     │
  │   (TSDB)    │    │  (Parquet)  │    │  (Labels)   │
  └─────────────┘    └─────────────┘    └─────────────┘
        │                   │                   │
        │                   │                   │
        └───────────────────┴───────────────────┘
                            │
                            ▼

┌──────────────────────────────────────────────────────────────────────────┐
│  PHASE 9: QUERY & VISUALIZATION                                          │
└──────────────────────────────────────────────────────────────────────────┘

            User queries
                   │
                   ├─→ Grafana dashboard
                   ├─→ API query (GraphQL)
                   ├─→ Trace search (TraceQL)
                   └─→ Alert evaluation
                          │
                          ▼
                    Results displayed
```

---

## 3. Sampling Decision Tree

```
                    ┌─────────────────┐
                    │  New LLM Span   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ Extract Metadata│
                    │ - duration      │
                    │ - status        │
                    │ - cost          │
                    └────────┬────────┘
                             │
                ┌────────────┴────────────┐
                │                         │
                ▼                         ▼
         ┌──────────────┐          ┌──────────────┐
         │ Is Error?    │          │ HEAD SAMPLING│
         │ (status=ERROR)│         │  (trace ID)  │
         └──────┬───────┘          └──────┬───────┘
                │                         │
         Yes ───┤                  Yes ───┤
                │                         │
                ▼                         ▼
         ┌──────────────┐          ┌──────────────┐
         │ SAMPLE 100%  │          │  SAMPLE 1%   │
         └──────┬───────┘          └──────┬───────┘
                │                         │
                │                  No ────┤
                │                         │
                │                         ▼
                │                  ┌──────────────┐
                │                  │  DROP 99%    │
                │                  │ (count only) │
                │                  └──────────────┘
                │
                ▼
         ┌──────────────┐
         │ Check Latency│
         └──────┬───────┘
                │
         > 5s ──┤
                │
                ▼
         ┌──────────────┐
         │ SAMPLE 100%  │
         └──────┬───────┘
                │
         < 5s ──┤
                │
                ▼
         ┌──────────────┐
         │  Check Cost  │
         └──────┬───────┘
                │
         > $1 ──┤
                │
                ▼
         ┌──────────────┐
         │ SAMPLE 100%  │
         └──────┬───────┘
                │
         < $1 ──┤
                │
                ▼
         ┌──────────────┐
         │ Probabilistic│
         │  Sample 1%   │
         └──────────────┘
```

---

## 4. Storage Tier Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│  HOT TIER (0-7 days)                                                     │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  Full Resolution Data                                              │ │
│  │  - All metrics (1s granularity)                                    │ │
│  │  - All sampled traces                                              │ │
│  │  - All logs                                                         │ │
│  │                                                                     │ │
│  │  Storage:                                                           │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │ │
│  │  │ TimescaleDB  │  │  Tempo (SSD) │  │  Loki (SSD)  │            │ │
│  │  │   (SSD)      │  │              │  │              │            │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘            │ │
│  │                                                                     │ │
│  │  Performance: < 100ms query latency                                │ │
│  │  Cost: $$$$ (highest)                                              │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
                                 │
                                 │ Auto-migration after 7 days
                                 ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  WARM TIER (7-30 days)                                                   │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  Downsampled Data                                                   │ │
│  │  - Metrics (1m granularity) via continuous aggregates              │ │
│  │  - Sampled traces (10% of original)                                │ │
│  │  - Error logs only                                                  │ │
│  │                                                                     │ │
│  │  Storage:                                                           │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │ │
│  │  │ TimescaleDB  │  │  Tempo (S3)  │  │  Loki (S3)   │            │ │
│  │  │ (Compressed) │  │ (Compressed) │  │ (Compressed) │            │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘            │ │
│  │                                                                     │ │
│  │  Performance: < 500ms query latency                                │ │
│  │  Cost: $$$ (medium)                                                │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
                                 │
                                 │ Auto-archival after 30 days
                                 ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  COLD TIER (30 days - 5 years)                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  Highly Compressed Data                                             │ │
│  │  - Metrics (1h granularity) via daily aggregates                   │ │
│  │  - Sampled traces (1% of original)                                 │ │
│  │  - Critical error logs only                                         │ │
│  │                                                                     │ │
│  │  Storage:                                                           │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │ │
│  │  │ TimescaleDB  │  │ S3 Glacier   │  │ S3 Glacier   │            │ │
│  │  │ (Aggregated) │  │  (Archives)  │  │  (Archives)  │            │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘            │ │
│  │                                                                     │ │
│  │  Performance: < 5s query latency (with restore)                    │ │
│  │  Cost: $ (lowest)                                                  │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Context Propagation Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│  RAG Application Example                                                 │
└──────────────────────────────────────────────────────────────────────────┘

User Query: "What is Rust?"
     │
     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  SPAN: rag.query                                                         │
│  trace_id: abc123                                                        │
│  span_id: root1                                                          │
│  parent_span_id: null                                                    │
│                                                                          │
│  W3C Context: traceparent=00-abc123-root1-01                            │
└─────────────────┬───────────────────────────────────────────────────────┘
                  │
      ┌───────────┴───────────┐
      │                       │
      ▼                       ▼
┌──────────────────┐    ┌──────────────────┐
│ SPAN: rag.embed  │    │ SPAN: rag.retrieve│
│ trace_id: abc123 │    │ trace_id: abc123  │
│ span_id: child1  │    │ span_id: child2   │
│ parent: root1    │    │ parent: root1     │
│                  │    │                   │
│ Context:         │    │ Context:          │
│ traceparent=     │    │ traceparent=      │
│ 00-abc123-       │    │ 00-abc123-        │
│ child1-01        │    │ child2-01         │
└──────┬───────────┘    └──────┬────────────┘
       │                       │
       │                       ▼
       │            ┌───────────────────────┐
       │            │ SPAN: vectordb.search │
       │            │ trace_id: abc123      │
       │            │ span_id: child2a      │
       │            │ parent: child2        │
       │            │                       │
       │            │ Context propagated    │
       │            │ via HTTP headers      │
       │            └───────────────────────┘
       │
       └──────────────────┐
                          │
                          ▼
              ┌─────────────────────────┐
              │ SPAN: llm.chat_completion│
              │ trace_id: abc123         │
              │ span_id: child3          │
              │ parent: root1            │
              │                          │
              │ Attributes:              │
              │ - gen_ai.system: openai  │
              │ - gen_ai.model: gpt-4    │
              │ - llm.cost_usd: 0.004    │
              │                          │
              │ Context:                 │
              │ traceparent=             │
              │ 00-abc123-child3-01      │
              └──────────────────────────┘

Final Trace Hierarchy:
abc123 (rag.query)
├── child1 (rag.embed)
├── child2 (rag.retrieve)
│   └── child2a (vectordb.search)
└── child3 (llm.chat_completion)
```

---

## 6. Scaling Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│  APPLICATION TIER (Horizontally Scalable)                                │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐        │
│  │  App Pod 1 │  │  App Pod 2 │  │  App Pod N │  │ Legacy App │        │
│  │  (SDK)     │  │  (SDK)     │  │  (SDK)     │  │  (Proxy)   │        │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘        │
└────────┼───────────────┼───────────────┼───────────────┼────────────────┘
         │               │               │               │
         └───────────────┴───────────────┴───────────────┘
                                │
                                ▼
                    ┌────────────────────────┐
                    │   Load Balancer (L7)   │
                    │   - Round Robin         │
                    │   - Health Checks       │
                    └───────────┬────────────┘
                                │
         ┌──────────────────────┼──────────────────────┐
         │                      │                      │
         ▼                      ▼                      ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│ OTel Collector 1 │  │ OTel Collector 2 │  │ OTel Collector N │
│  (Stateless)     │  │  (Stateless)     │  │  (Stateless)     │
│                  │  │                  │  │                  │
│ Resources:       │  │ Resources:       │  │ Resources:       │
│ - 2 vCPU         │  │ - 2 vCPU         │  │ - 2 vCPU         │
│ - 4 GB RAM       │  │ - 4 GB RAM       │  │ - 4 GB RAM       │
│                  │  │                  │  │                  │
│ Throughput:      │  │ Throughput:      │  │ Throughput:      │
│ 100k spans/sec   │  │ 100k spans/sec   │  │ 100k spans/sec   │
└────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘
         │                     │                      │
         └─────────────────────┼──────────────────────┘
                               │
                ┌──────────────┼──────────────┐
                │              │              │
                ▼              ▼              ▼
     ┌────────────────┐ ┌────────────┐ ┌─────────────┐
     │  TimescaleDB   │ │   Tempo    │ │    Loki     │
     │   Cluster      │ │  Cluster   │ │  Cluster    │
     └────────────────┘ └────────────┘ └─────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│  STORAGE TIER (Horizontally & Vertically Scalable)                       │
└──────────────────────────────────────────────────────────────────────────┘

TimescaleDB Cluster:
┌────────────────┐      ┌────────────────┐      ┌────────────────┐
│   Primary      │ ───→ │   Replica 1    │      │   Replica 2    │
│   (Write)      │      │   (Read)       │      │   (Read)       │
└────────────────┘      └────────────────┘      └────────────────┘
        │
        ▼
┌────────────────┐
│  Compression   │
│  & Retention   │
│   Background   │
│    Workers     │
└────────────────┘

Tempo Cluster:
┌────────────────┐      ┌────────────────┐      ┌────────────────┐
│ Distributor 1  │      │ Distributor 2  │      │ Distributor N  │
└────────┬───────┘      └────────┬───────┘      └────────┬───────┘
         │                       │                       │
         └───────────────────────┴───────────────────────┘
                                 │
                  ┌──────────────┼──────────────┐
                  │              │              │
                  ▼              ▼              ▼
         ┌────────────┐  ┌────────────┐  ┌────────────┐
         │ Ingester 1 │  │ Ingester 2 │  │ Ingester N │
         └──────┬─────┘  └──────┬─────┘  └──────┬─────┘
                │               │               │
                └───────────────┴───────────────┘
                                │
                                ▼
                    ┌────────────────────────┐
                    │   Object Storage (S3)  │
                    │   - Parquet blocks     │
                    │   - Auto-sharding      │
                    │   - Lifecycle policies │
                    └────────────────────────┘

Loki Cluster:
[Similar architecture to Tempo, with label-based indexing]

Auto-Scaling Triggers:
┌────────────────────────────────────────────────────────────────────┐
│ - CPU > 70% for 5 minutes → Scale up collectors                   │
│ - Queue depth > 1500 → Scale up collectors                         │
│ - Storage I/O > 80% → Add read replicas (TimescaleDB)             │
│ - Query latency > 1s → Scale up queriers (Tempo/Loki)             │
└────────────────────────────────────────────────────────────────────┘
```

---

## 7. Security Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│  APPLICATION LAYER                                                       │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  SDK with PII Scrubbing                                            │ │
│  │  ┌──────────────────────────────────────────────────────────────┐ │ │
│  │  │  Before Export:                                               │ │ │
│  │  │  1. Remove prompts/responses                                  │ │ │
│  │  │  2. Hash sensitive data (SHA-256)                             │ │ │
│  │  │  3. Redact user IDs (optional)                                │ │ │
│  │  │  4. Apply custom scrubbing rules                              │ │ │
│  │  └──────────────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────┬─────────────────────────────────────────────┘
                             │
                             │ TLS 1.3 (mTLS optional)
                             ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  NETWORK LAYER                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  Encrypted Transit (TLS 1.3)                                       │ │
│  │  - Certificate-based authentication                                │ │
│  │  - Perfect forward secrecy                                         │ │
│  │  - Strong cipher suites only                                       │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────┬─────────────────────────────────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  COLLECTION LAYER                                                        │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  OTel Collector (Hardened)                                         │ │
│  │  - Network policies (whitelist IPs)                                │ │
│  │  - Rate limiting (per source)                                      │ │
│  │  - Additional filtering/redaction                                  │ │
│  │  - Audit logging                                                   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────┬─────────────────────────────────────────────┘
                             │
                             │ Internal TLS + RBAC
                             ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  STORAGE LAYER                                                           │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  Encryption at Rest                                                 │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │ │
│  │  │ TimescaleDB  │  │    Tempo     │  │     Loki     │            │ │
│  │  │ (AES-256)    │  │  (S3 SSE)    │  │  (S3 SSE)    │            │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘            │ │
│  │                                                                     │ │
│  │  Access Control:                                                    │ │
│  │  - Database-level RBAC                                             │ │
│  │  - IAM roles for S3 access                                         │ │
│  │  - Audit trails for all queries                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└────────────────────────────┬─────────────────────────────────────────────┘
                             │
                             │ HTTPS + JWT
                             ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  QUERY LAYER                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │  API Gateway (Authentication & Authorization)                       │ │
│  │  - JWT-based authentication                                         │ │
│  │  - RBAC for query permissions                                       │ │
│  │  - Rate limiting (per user/org)                                     │ │
│  │  - Query audit logging                                              │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
```

---

**End of Diagrams**
